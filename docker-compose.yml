# =====================================================
# HRM System - Docker Compose Deployment
# =====================================================
#
# Chạy toàn bộ hệ thống: docker compose up -d
# Reset toàn bộ: docker compose down -v && docker compose up -d
#
# Cấu trúc thư mục yêu cầu:
#   hrm/
#   ├── hrm-deployment/     (folder này)
#   ├── hrm-employee-service/
#   ├── hrm-Time-Service/
#   ├── hrm-Notification-Service/
#   ├── hrm-ApiGateway/
#   └── hrm-nextjs/
#
# Ports:
#   - 3000: Frontend (Next.js)
#   - 5000: API Gateway (REST/GraphQL)
#   - 5100: Socket Service (WebSocket)
#   - 8080: Keycloak (SSO)
#   - 15672: RabbitMQ Management
#   - 9001: MinIO Console
# =====================================================

services:
  # =====================================================
  # INFRASTRUCTURE - Databases
  # =====================================================

  postgres-employee:
    image: postgres:16-alpine
    container_name: hrm-postgres-employee
    environment:
      POSTGRES_USER: employee_user
      POSTGRES_PASSWORD: employee_pass
      POSTGRES_DB: employee_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_employee_data:/var/lib/postgresql/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U employee_user -d employee_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-time:
    image: postgres:16-alpine
    container_name: hrm-postgres-time
    environment:
      POSTGRES_USER: time_user
      POSTGRES_PASSWORD: time_pass
      POSTGRES_DB: time_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_time_data:/var/lib/postgresql/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U time_user -d time_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-notification:
    image: postgres:16-alpine
    container_name: hrm-postgres-notification
    environment:
      POSTGRES_USER: notification_user
      POSTGRES_PASSWORD: notification_pass
      POSTGRES_DB: notification_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_notification_data:/var/lib/postgresql/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U notification_user -d notification_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-keycloak:
    image: postgres:16-alpine
    container_name: hrm-postgres-keycloak
    environment:
      POSTGRES_USER: keycloak_user
      POSTGRES_PASSWORD: keycloak_pass
      POSTGRES_DB: keycloak_db
    ports:
      - "5435:5432"
    volumes:
      - postgres_keycloak_data:/var/lib/postgresql/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak_user -d keycloak_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Authz Database với schema tự động init
  postgres-authz:
    image: postgres:16-alpine
    container_name: hrm-postgres-authz
    environment:
      POSTGRES_USER: authz_user
      POSTGRES_PASSWORD: authz_pass
      POSTGRES_DB: authz_db
    ports:
      - "5436:5432"
    volumes:
      - ./infrastructure/authz/schema.postgres.sql:/docker-entrypoint-initdb.d/schema.sql:ro
      - postgres_authz_data:/var/lib/postgresql/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U authz_user -d authz_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =====================================================
  # INFRASTRUCTURE - Cache & Message Queue
  # =====================================================

  redis:
    image: redis:7-alpine
    container_name: hrm-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: hrm-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: hrm_user
      RABBITMQ_DEFAULT_PASS: hrm_pass
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 10s
      retries: 5

  # =====================================================
  # INFRASTRUCTURE - Keycloak SSO
  # =====================================================

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: hrm-keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-keycloak:5432/keycloak_db
      KC_DB_USERNAME: keycloak_user
      KC_DB_PASSWORD: keycloak_pass
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_HEALTH_ENABLED: "true"
    command: start-dev --import-realm
    ports:
      - "8080:8080"
    volumes:
      - ./infrastructure/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    depends_on:
      postgres-keycloak:
        condition: service_started
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 30s

  # =====================================================
  # INFRASTRUCTURE - MinIO Object Storage
  # =====================================================

  minio:
    image: minio/minio:latest
    container_name: hrm-minio
    environment:
      MINIO_ROOT_USER: minio_user
      MINIO_ROOT_PASSWORD: minio_pass
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # SOCKET SERVICE - Real-time WebSocket (học từ VMS)
  # =====================================================

  socket-service:
    build:
      context: ./infrastructure/socket
      dockerfile: Dockerfile
    container_name: hrm-socket
    restart: unless-stopped
    environment:
      SERVER_PORT: "5001"
      AUTH_API: "http://api-gateway:8080/api/auth/me"
      RABBITMQ_HOST: "rabbitmq"
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: "hrm_user"
      RABBITMQ_PASSWORD: "hrm_pass"
      RABBITMQ_WORK_QUEUE_NAME: "hrm_socket_work_queue"
    ports:
      - "5100:5001"
    depends_on:
      rabbitmq:
        condition: service_started
    networks:
      - hrm-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # APPLICATION SERVICES
  # =====================================================

  # Employee Service (gRPC) - Quản lý nhân viên
  employee-service:
    build:
      context: ../hrm-employee-service
      dockerfile: Dockerfile
    container_name: hrm-employee-service
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:8080;http://+:8081"
      ConnectionStrings__DefaultConnection: "Host=postgres-employee;Port=5432;Database=employee_db;Username=employee_user;Password=employee_pass"
      Keycloak__Authority: "http://keycloak:8080/realms/hrm"
      Keycloak__Audience: "hrm-api"
      Keycloak__ClientId: "hrm-api"
      Keycloak__ClientSecret: "hrm-api-secret"
      Keycloak__RequireHttps: "false"
    ports:
      - "5001:8080"
      - "5002:8081"
    depends_on:
      postgres-employee:
        condition: service_started
      keycloak:
        condition: service_started
    networks:
      - hrm-network

  # Time Service (gRPC) - Chấm công, nghỉ phép, tăng ca
  time-service:
    build:
      context: ../hrm-Time-Service
      dockerfile: Dockerfile
    container_name: hrm-time-service
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:8080;http://+:8081"
      ConnectionStrings__DefaultConnection: "Host=postgres-time;Port=5432;Database=time_db;Username=time_user;Password=time_pass"
      ConnectionStrings__Redis: "redis:6379"
      RabbitMQ__Host: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__Username: "hrm_user"
      RabbitMQ__Password: "hrm_pass"
      RabbitMQ__SocketQueueName: "hrm_socket_work_queue"
      GrpcServices__EmployeeService: "http://employee-service:8081"
      Keycloak__Authority: "http://keycloak:8080/realms/hrm"
      Keycloak__Audience: "hrm-api"
      Keycloak__ClientId: "hrm-api"
      Keycloak__ClientSecret: "hrm-api-secret"
      Keycloak__RequireHttps: "false"
    ports:
      - "5003:8080"
      - "5004:8081"
    depends_on:
      postgres-time:
        condition: service_started
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started
      employee-service:
        condition: service_started
      keycloak:
        condition: service_started
    networks:
      - hrm-network

  # Notification Service (SignalR) - Thông báo real-time
  notification-service:
    build:
      context: ../hrm-Notification-Service
      dockerfile: Dockerfile
    container_name: hrm-notification-service
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:8080"
      ConnectionStrings__DefaultConnection: "Host=postgres-notification;Port=5432;Database=notification_db;Username=notification_user;Password=notification_pass"
      RabbitMQ__Host: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__Username: "hrm_user"
      RabbitMQ__Password: "hrm_pass"
      RabbitMQ__SocketQueueName: "hrm_socket_work_queue"
      Keycloak__Authority: "http://keycloak:8080/realms/hrm"
      Keycloak__Audience: "hrm-api"
      Keycloak__RequireHttps: "false"
    ports:
      - "5005:8080"
    depends_on:
      postgres-notification:
        condition: service_started
      rabbitmq:
        condition: service_started
      keycloak:
        condition: service_started
    networks:
      - hrm-network

  # API Gateway (REST + GraphQL) - Entry point
  api-gateway:
    build:
      context: ../hrm-ApiGateway
      dockerfile: Dockerfile
    container_name: hrm-api-gateway
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:8080"
      GrpcServices__EmployeeService: "http://employee-service:8081"
      GrpcServices__TimeService: "http://time-service:8081"
      NotificationService__Url: "http://notification-service:8080"
      Keycloak__Authority: "http://keycloak:8080/realms/hrm"
      Keycloak__Audience: "hrm-api"
      Keycloak__ClientId: "hrm-api"
      Keycloak__ClientSecret: "hrm-api-secret"
      Keycloak__RequireHttps: "false"
      Cors__AllowedOrigins__0: "http://localhost:3000"
      Cors__AllowedOrigins__1: "http://127.0.0.1:3000"
    ports:
      - "5000:8080"
    depends_on:
      employee-service:
        condition: service_started
      time-service:
        condition: service_started
      notification-service:
        condition: service_started
    networks:
      - hrm-network

  # Frontend (Next.js) - Web UI
  frontend:
    build:
      context: ../hrm-nextjs
      dockerfile: Dockerfile
    container_name: hrm-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: "http://localhost:5000"
      NEXT_PUBLIC_KEYCLOAK_URL: "http://localhost:8080"
      NEXT_PUBLIC_KEYCLOAK_REALM: "hrm"
      NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: "hrm-frontend"
      NEXT_PUBLIC_NOTIFICATION_HUB_URL: "http://localhost:5005/hubs/notification"
      NEXT_PUBLIC_SOCKET_URL: "http://localhost:5100"
    ports:
      - "3000:3000"
    depends_on:
      api-gateway:
        condition: service_started
    networks:
      - hrm-network

# =====================================================
# VOLUMES
# =====================================================
volumes:
  postgres_employee_data:
  postgres_time_data:
  postgres_notification_data:
  postgres_keycloak_data:
  postgres_authz_data:
  redis_data:
  rabbitmq_data:
  minio_data:

# =====================================================
# NETWORKS
# =====================================================
networks:
  hrm-network:
    driver: bridge
